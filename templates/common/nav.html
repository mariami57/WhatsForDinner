
{% load static %}

<div class="nav-block">
    <div class="logo-img">
        <a href="{% url 'home' %}">
            <img src="{% static 'images/whatsfordinner_logo2.png' %}" alt="logo">
        </a>

    </div>

    <nav>
        <ul>
            <div class="search-bars">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder='Search here'>
                    <ul id="search-results" class="search-results"></ul>

                </div>
                <div class="search-bar2">
                    <input type="number" id="time-input" placeholder='Cooking time (min)'>
                    <ul id="search-results2" class="search-results2"></ul>
                </div>
            </div>

            <li>
                <a href="{%  url 'home' %}">Home</a>
            </li>

            {% if request.user.is_authenticated %}
                <li class="dropdown {% if request.resolver_match.url_name in 'all-recipes my-recipes favourite-recipes' %}open{% endif %}">
                    <a href="{%  url 'all-recipes' %}">Recipes</a>
                    <ul class="dropdown-menu">
                        <li class="tooltip-container"><a href="{% url 'create-recipe' %}">
                            <i class="fa-solid fa-circle-plus"></i>
                            <span class="tooltip-text">Add Recipe</span>
                        </a></li>
                        <li class="tooltip-container"><a href="{% url 'my-recipes' %}">
                            <i class="fa-solid fa-book"></i>
                            <span class="tooltip-text">My Recipes</span>
                        </a></li>
                        <li class="tooltip-container"><a href="{% url 'favourite-recipes' %}">
                            <i class="fa-solid fa-heart"></i>
                            <span class="tooltip-text">Favourite Recipies</span>
                        </a></li>
                    </ul>
                </li>
                <li>
                    <a href="{% url 'profile-details' pk=request.user.pk%}">Profile</a>
                </li>

                <li>
                    <a href="{% url 'logout' %}" onclick="event.preventDefault(); document.getElementById('logout-form').submit()">Log Out</a>
                </li>
            {% else %}
                <li>
                    <a href="{%  url 'all-recipes' %}">Recipes</a>
                </li>
                <li>
                    <a href="{% url 'login' %}">Log In</a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>

<form style="display:none" id="logout-form" action="{% url 'logout' %}" method="POST">
    {% csrf_token %}
</form>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        const input = document.getElementById('search-input');
        const resultsBox = document.getElementById('search-results');

        document.addEventListener("click", function (e) {
            if (resultsBox && !resultsBox.contains(e.target)){
                resultsBox.style.display = 'none';
            }
        });
        input.addEventListener('input', function(){
            const query = this.value.trim();

            if (query.length < 2) {
                resultsBox.innerHTML = '';
                resultsBox.style.display = 'none';
                return;
            }

            fetch(`/api/search/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsBox.innerHTML = '';

                    if (data.length === 0) {
                        resultsBox.style.display = 'none';

                        return;
                    }
                    resultsBox.style.display = 'block';

                    data.forEach(item => {
                        const link = document.createElement('a');
                        link.href = `/recipes/${item.pk}/details`;
                        link.textContent= item.label1 || item.label2 || item.label3 || item.label4 || 'Result'
                        link.style.display ='block';
                        resultsBox.appendChild(link);
                    });
                })
                .catch(error => {
                    console.error('Search error:', error);
                    resultsBox.style.display = 'none';
                });

        });

        const timeInput = document.getElementById('time-input');
        timeInput.addEventListener('input', function(){
            const time = this.value.trim();
            if (!time) return;

            fetch(`/api/search/?time=${encodeURIComponent(time)}`)
                .then(response => response.json())
                .then(data => {
                    resultsBox.innerHTML = '';
                    if (data.length === 0) {
                        resultsBox.style.display = 'none';
                        return;
                    }
                    resultsBox.style.display ='block';
                    data.forEach(item => {
                        const link = document.createElement('a');
                        link.href = item.url;
                        link.textContent = item.label4;
                        link.style.display = 'block';
                        resultsBox.appendChild(link);
                    });
                })
                .catch(error => {
                    console.error('Time search error:', error);
                    resultsBox.style.display = 'none';
                });
        })
    });
</script>